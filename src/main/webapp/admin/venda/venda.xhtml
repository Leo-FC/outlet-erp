<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
<h:head>
    <title>Ponto de Venda - Outshop</title>
    <style type="text/css">
        body {
            background-color: #f4f6f8;
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .venda-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }
        .coluna-esquerda {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .coluna-direita {
            flex: 1;
        }
        .ui-panel .ui-panel-content {
             padding: 1.25rem;
        }
    </style>
</h:head>
<h:body>
    <p:growl id="messages" showDetail="true" />
    
    <h:form id="vendaForm">
        <div class="venda-container">
            
            <div class="coluna-esquerda">
                <p:panel header="1. Adicionar Produtos">
                    <p:panelGrid columns="2" styleClass="ui-noborder" style="width:100%;">
                        <p:outputLabel for="produto" value="Produto:" />
                        <h:panelGroup style="display: flex;">
                            <p:selectOneMenu id="produto" value="#{vendaBean.produtoSelecionado}" requiredMessage="Selecione um produto"
                                             converter="omnifaces.SelectItemsConverter">
                                <f:selectItem itemLabel="Selecione..." itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems value="#{vendaBean.todosProdutos}" var="prod"
                                               itemLabel="#{prod.nomeProduto}" itemValue="#{prod}"/>
                            </p:selectOneMenu>
                            <p:commandButton type="button" icon="pi pi-search"
                                             onclick="PF('dlgProdutos').show()"
                                             style="margin-left: 5px;"/>
                        </h:panelGroup>
                        
                        <p:outputLabel for="quantidade" value="Quantidade:" />
                        <p:inputNumber id="quantidade" value="#{vendaBean.quantidadeSelecionada}" required="true" 
                                       requiredMessage="Informe a quantidade" decimalPlaces="0"/>
                    </p:panelGrid>
                    <p:commandButton value="Adicionar ao carrinho" icon="pi pi-shopping-cart"
                                     actionListener="#{vendaBean.adicionarItem}" 
                                     update="carrinho messages"
                                     process="produto quantidade @this"
                                     style="margin-top:15px;" />
                </p:panel>
                
                <p:panel header="2. Finalizar Venda">
                    <p:panelGrid columns="2" styleClass="ui-noborder" style="width:100%;">
                         <p:outputLabel for="cliente" value="Cliente (Opcional):" />
                         <h:panelGroup style="display: flex;">
                             <p:selectOneMenu id="cliente" value="#{vendaBean.clienteSelecionado}"
                                              converter="omnifaces.SelectItemsConverter" filter="true">
                                 <f:selectItem itemLabel="Consumidor Final" itemValue="#{null}" noSelectionOption="true"/>
                                 <f:selectItems value="#{vendaBean.todosClientes}" var="cli"
                                                itemLabel="#{cli.nomeCompleto}" itemValue="#{cli}"/>
                             </p:selectOneMenu>
                             <p:commandButton type="button" icon="pi pi-search"
                                              onclick="PF('dlgClientes').show()" style="margin-left: 5px;" />
                         </h:panelGroup>

                         <p:outputLabel for="formaPagamento" value="Forma de Pagamento:" />
                         <p:selectOneMenu id="formaPagamento" value="#{vendaBean.formaPagamentoSelecionada}" required="true"
                                          requiredMessage="Selecione a forma de pagamento">
                             <f:selectItem itemLabel="Selecione..." itemValue="#{null}" noSelectionOption="true"/>
                             <f:selectItems value="#{vendaBean.formasDePagamento}" var="fp" itemLabel="#{fp}" itemValue="#{fp}" />
                         </p:selectOneMenu>
                    </p:panelGrid>
                </p:panel>
            </div>

            <div class="coluna-direita">
                <p:panel header="Carrinho de Compras">
                    <p:dataTable id="carrinho" var="item" value="#{vendaBean.carrinhoDeCompras}" emptyMessage="O carrinho está vazio.">
                        <p:column headerText="Produto">
                            <h:outputText value="#{item.produto.nomeProduto}" />
                        </p:column>
                        <p:column headerText="Qtd" style="width:60px; text-align:center;">
                            <h:outputText value="#{item.quantidade}" />
                        </p:column>
                        <p:column headerText="Preço Un.">
                            <h:outputText value="#{item.valorUnitario}">
                                 <f:convertNumber type="currency" currencySymbol="R$" locale="pt_BR" />
                            </h:outputText>
                        </p:column>
                        <p:column headerText="Subtotal">
                            <h:outputText value="#{item.valorTotal}">
                                 <f:convertNumber type="currency" currencySymbol="R$" locale="pt_BR" />
                            </h:outputText>
                        </p:column>
                        <p:column style="width:50px; text-align:center;">
                            <p:commandButton icon="pi pi-times" title="Remover" actionListener="#{vendaBean.removerItem(item)}" 
                                             update="carrinho messages" process="@this" styleClass="ui-button-danger ui-button-flat"/>
                        </p:column>
                        
                        <f:facet name="footer">
                            <div style="text-align:right; font-weight: bold; font-size: 1.2em;">
                                Total: <h:outputText value="#{vendaBean.venda.valorTotal}">
                                     <f:convertNumber type="currency" currencySymbol="R$" locale="pt_BR" />
                                </h:outputText>
                            </div>
                        </f:facet>
                    </p:dataTable>
                </p:panel>
            </div>
        </div>

        <div style="margin-top: 15px; display: flex; justify-content: center; gap: 15px">
            <p:button value="Voltar para o Painel" outcome="/admin/painelAdmin.xhtml" icon="pi pi-arrow-left" styleClass="ui-button-secondary"/>
            <p:commandButton value="Finalizar Venda" icon="pi pi-check"
                             actionListener="#{vendaBean.finalizarVenda}"
                             oncomplete="if (!args.validationFailed) PF('dialogoRecibo').show()"
                             update="messages carrinho"
                             process="formaPagamento cliente @this"
                             styleClass="ui-button-success" />
        </div>
    </h:form>
    
    <p:dialog 
        header="Pesquisar Produto" 
        widgetVar="dlgProdutos" 
        modal="true" 
        showEffect="fade" 
        hideEffect="fade" 
        resizable="false"
        width="800">
        
        <h:form id="dlgProdutoForm">
            <p:dataTable 
                id="produtosTable"
                value="#{vendaBean.todosProdutos}" 
                var="produto" 
                widgetVar="produtosTable" 
                paginator="true" 
                rows="10"
                emptyMessage="Nenhum produto encontrado.">
                
                <f:facet name="header">
                    <p:inputText id="globalFilter" onkeyup="PF('produtosTable').filter()" placeholder="Pesquisar..."/>
                </f:facet>
                
                <p:column headerText="Código" filterBy="#{produto.idProduto}" sortBy="#{produto.idProduto}">
                    <h:outputText value="#{produto.idProduto}" />
                </p:column>
                
                <p:column headerText="Nome" filterBy="#{produto.nomeProduto}" sortBy="#{produto.nomeProduto}">
                    <h:outputText value="#{produto.nomeProduto}" />
                </p:column>
                
                <p:column headerText="Preço" filterBy="#{produto.preco}" sortBy="#{produto.preco}">
                    <h:outputText value="#{produto.preco}">
                        <f:convertNumber type="currency" currencySymbol="R$" locale="pt_BR" />
                    </h:outputText>
                </p:column>

                <p:column headerText="Ação" style="width: 80px; text-align: center;">
                    <p:commandButton value="Selecionar" 
                                     oncomplete="PF('dlgProdutos').hide()" 
                                     action="#{vendaBean.selecionarProduto(produto)}"
                                     update=":vendaForm" />
                </p:column>
            </p:dataTable>
        </h:form>
    </p:dialog>
    
    <p:dialog 
        header="Pesquisar Cliente" 
        widgetVar="dlgClientes" 
        modal="true" 
        showEffect="fade" 
        hideEffect="fade" 
        resizable="false"
        width="800">
        
        <h:form id="dlgClienteForm">
            <p:dataTable 
                id="clientesTable"
                value="#{vendaBean.todosClientes}" 
                var="cliente" 
                widgetVar="clientesTable" 
                paginator="true" 
                rows="10"
                emptyMessage="Nenhum cliente encontrado.">
                
                <f:facet name="header">
                    <p:inputText id="globalFilter" onkeyup="PF('clientesTable').filter()" placeholder="Pesquisar..."/>
                </f:facet>
                
                <p:column headerText="Código" filterBy="#{cliente.id}" sortBy="#{cliente.id}">
                    <h:outputText value="#{cliente.id}" />
                </p:column>
                
                <p:column headerText="Nome" filterBy="#{cliente.nomeCompleto}" sortBy="#{cliente.nomeCompleto}">
                    <h:outputText value="#{cliente.nomeCompleto}" />
                </p:column>
                
                <p:column headerText="CPF" filterBy="#{cliente.cpf}" sortBy="#{cliente.cpf}">
                    <h:outputText value="#{cliente.cpf}" />
                </p:column>

                <p:column headerText="Ação" style="width: 80px; text-align: center;">
                    <p:commandButton value="Selecionar" 
                                     oncomplete="PF('dlgClientes').hide()" 
                                     action="#{vendaBean.selecionarCliente(cliente)}"
                                     update=":vendaForm" />
                </p:column>
            </p:dataTable>
        </h:form>
    </p:dialog>
    
	<p:dialog header="Recibo de Venda" widgetVar="dialogoRecibo" modal="true">
	    <h:form>
	        <h:outputText value="Venda finalizada com sucesso! O que você gostaria de fazer com o recibo?" style="font-weight: bold;"/>
	        <p:panelGrid columns="2" style="margin-top:20px;">
	            <p:commandButton value="Baixar Recibo" styleClass="ui-button-success" ajax="false">
	                <p:fileDownload value="#{vendaBean.recibo}" />
	            </p:commandButton>
	            <p:commandButton value="Visualizar Recibo" styleClass="ui-button-info" ajax="false">
	                <p:fileDownload value="#{vendaBean.recibo}" />
	            </p:commandButton>
	        </p:panelGrid>
	        <p:commandButton value="Fechar" onclick="PF('dialogoRecibo').hide()" style="margin-top: 10px;"/>
	    </h:form>
	</p:dialog>
</h:body>
</html>